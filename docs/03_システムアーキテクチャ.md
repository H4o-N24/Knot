# システムアーキテクチャとデータベース設計

## 技術スタック（推奨）
- **Backend**: Node.js (TypeScript) + Discord.js
- **Database**: PostgreSQL (Prisma ORM) - 複雑な条件抽出（JOIN）に強いため。
- **Hosting**: Cloudflare Workers (D1) または Railway/Fly.io (スケーラビリティ重視)
- **Payment**: Stripe (Checkout / Webhooks)

## データベース設計 (ER図案)

| テーブル名 | 用途 | 主要カラム |
| :--- | :--- | :--- |
| **Guilds** | サーバー設定 | guild_id, plan_type (Free/Pro), timezone |
| **Users** | ユーザー情報 | user_id, discord_tag, stripe_customer_id |
| **Availability** | 空き日情報 | user_id, guild_id, date (DATE型), status |
| **Events** | イベント情報 | event_id, guild_id, title, min_participants, max_participants, status |
| **EventRequirements** | 必須メンバー等 | event_id, required_user_id |
| **EventParticipants** | 参加確定者 | event_id, user_id, joined_at (先着順管理用) |

## 最適日抽出アルゴリズム (SQL/Logic)
1. 特定の期間（翌月など）の `Availability` を `date` ごとに集計。
2. `EventRequirements` に含まれる「必須メンバー」が全員 `status=Available` な日のみをフィルタリング。
3. 残った日を「参加可能人数」で降順ソート。
4. `min_participants` を満たさない日を除外。
5. 上位3件をレスポンス。

## API連携を考慮した「疎結合」設計
- **Provider Pattern**: 将来的にGoogle Calendar APIを追加する際、`Availability` テーブルへの書き込みを「Discordからの手動登録」と「外部APIからの自動同期」の両方から行えるよう、データソースを抽象化しておく。
- **Webhook Listener**: Stripeからの支払い完了通知を受け取り、即座に `Guilds.plan_type` を更新する独立したエンドポイントを用意。
